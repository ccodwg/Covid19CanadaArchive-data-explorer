<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="./favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
    <!-- treejs: https://www.cssscript.com/folder-tree-treejs/ -->
    <script src="lib/treejs/tree.min.js"></script>
    <link rel="stylesheet" href="lib/treejs/treejs.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <style>
        h2.leftpad {
            padding-left: 1%;
        }
        p.leftpad {
            padding-left: 1%;
        }
        div.half {
            box-sizing: border-box;
            width: 50%;
            padding-left: 2%;
            padding-right: 4%;
            display: inline-block;
            vertical-align: text-top;
            border-style: double;
        }
        div.half-right {
            display: none;
            padding-top: 1%;
            padding-bottom: 1%;
            /* position: fixed; */
            /* top: 20px; */
        }
        div.fullpad {
            padding-left: 1%;
            padding-right: 1%;
            padding-top: 1%;
            padding-bottom: 1%;
            border-style: double;
        }
        #table-files, #table-datasets td {
            word-break: break-word
        }
    </style>
    <script>

        // function: get datasets
        async function getDatasets() {
            // request JSON from API
            let response = await fetch('https://api.opencovid.ca/datasets')
            let json = await response.json()
            // return JSON data
            return json
        }

        // function: get directories
        async function getDirs(json_datasets) {
            let parent_dirs = []
            // get parent directories ('meta_group_1')
            Object.keys(json_datasets).forEach(function(k) {
                parent_dirs.push(json_datasets[k]['metadata']['meta_group_1'])
            });
            // sort unique values
            parent_dirs = [...new Set(parent_dirs)].sort()
            // move 'other' directories to the end of the array
            let max_dirs = parent_dirs.length
            let parent_dirs_other = []
            for (let i = 0; i < max_dirs; i++) {
                d = parent_dirs[i]
                if (d.match('Other: ')) {
                    parent_dirs_other.push(d)
                }
            };
            parent_dirs = parent_dirs.filter(function(d) {
                return !d.match('Other: ')
            });
            parent_dirs = parent_dirs.concat(parent_dirs_other)
            // convert array to object
            dirs = parent_dirs.reduce(function(obj, item) {
                obj[item] = {};
                return obj;
            }, {});
            // add second-level directories ('meta_group_2') to top-level directories
            Object.keys(json_datasets).forEach(function(k) {
                let dir = json_datasets[k]['metadata']['meta_group_1']
                let subdir = json_datasets[k]['metadata']['meta_group_2']
                if (subdir != undefined) {
                    dirs[dir][subdir] = {}
                };
            });
            // add second-level directory 'Parent' to top-level directories (in last place)
            Object.keys(dirs).forEach(function(k) {
                dirs[k]['Parent'] = {}
            });
            // add file groups ('meta_url_name') to second-level directories
            Object.keys(json_datasets).forEach(function(k) {
                let dir = json_datasets[k]['metadata']['meta_group_1']
                let subdir = json_datasets[k]['metadata']['meta_group_2']
                let file_group = json_datasets[k]['metadata']['meta_url_name']
                if (subdir == undefined) {
                    dirs[dir]['Parent'][file_group] = {}
                } else {
                    dirs[dir][subdir][file_group] = {}
                };
            });
            // sort file groups
            Object.keys(dirs).forEach(function(k) {
                Object.keys(dirs[k]).forEach(function(k2) {
                    dirs[k][k2] = Object.keys(dirs[k][k2]).sort().reduce(function(obj, item) {
                        obj[item] = dirs[k][k2][item];
                        return obj;
                    }, {});
                });
            });
            // return object
            return dirs
        }

        // function: add files to directories
        async function getFiles(json_datasets, dirs) {
            // add files to directories
            Object.keys(json_datasets).forEach(function(k) {
                let dir = json_datasets[k]['metadata']['meta_group_1']
                let subdir = json_datasets[k]['metadata']['meta_group_2']
                let file_group = json_datasets[k]['metadata']['meta_url_name']
                let file = json_datasets[k]['metadata']['meta_name']
                if (subdir == undefined) {
                    dirs[dir]['Parent'][file_group][file] = json_datasets[k]
                } else {
                    dirs[dir][subdir][file_group][file] = json_datasets[k]
                };
            });
            // sort files
            Object.keys(dirs).forEach(function(k) {
                Object.keys(dirs[k]).forEach(function(k2) {
                    Object.keys(dirs[k][k2], function(k3) {
                        dirs[k][k2][k3] = Object.keys(dirs[k][k2][k3]).sort().reduce(function(obj, item) {
                            obj[item] = dirs[k][k2][k3][item];
                            return obj;
                        }, {});
                    });
                });
            });
            // return object
            return dirs
        }
        
        // function: build tree
        async function buildTree(dirs) {
            let root = new TreeNode('Archive')
            // add nodes for first-level directories
            Object.keys(dirs).forEach(function(k) {
                let node = new TreeNode(k)
                root.addChild(node)
                // add nodes for second-level directories
                Object.keys(dirs[k]).forEach(function(k2) {
                    if (k2 != 'Parent') {
                        // second-level directory exists
                        let node2 = new TreeNode(k2)
                        node.addChild(node2)
                        // add nodes for third-level directories
                        Object.keys(dirs[k][k2]).forEach(function(k3) {
                            let node3 = new TreeNode(k3)
                            node2.addChild(node3)
                            // add nodes for files
                            Object.keys(dirs[k][k2][k3]).forEach(function(k4) {
                                let node4 = new TreeNode(k4)
                                node4.on('click', function(){buildTableFiles(dirs[k][k2][k3][k4]['uuid']);}) // add table build function on click
                                node3.addChild(node4)
                            });
                            node3.setExpanded(false) // collapsed by default
                        });
                        node2.setExpanded(false) // collapsed by default
                    } else {
                        // second-level directory does not exist (i.e., use parent directory)
                        // add third-level directories
                        Object.keys(dirs[k][k2]).forEach(function(k3) {
                            let node3 = new TreeNode(k3)
                            node.addChild(node3)
                            // add nodes for files
                            Object.keys(dirs[k][k2][k3]).forEach(function(k4) {
                                let node4 = new TreeNode(k4)
                                node4.on('click', function(){buildTableFiles(dirs[k][k2][k3][k4]['uuid']);}) // add table build function on click
                                node3.addChild(node4)
                            });
                            node3.setExpanded(false) // collapsed by default
                        });
                    };
                });
                node.setExpanded(false) // collapsed by default
            });
            // return tree
            return root
        }

        // function: get UUID
        async function getUUID(uuid) {
            let api_url = 'https://api.opencovid.ca/archive?uuid=' + uuid
            // request JSON from API
            let response = await fetch(api_url)
            let json = await response.json()
            // return JSON data
            return json
        }

        // function: build files table
        async function buildTableFiles(uuid) {

            // get JSON for UUID
            const json_uuid = await getUUID(uuid)
            
            // modify raw variables
            Object.keys(json_uuid['data']).forEach(function (i) {
                // construct HTML link to file for table
                json_uuid['data'][i]['file_link'] = '<a href="' + json_uuid['data'][i]['file_url'] + '">' + json_uuid['data'][i]['file_name'] + '</a>'
                // convert bytes to MB
                json_uuid['data'][i]['file_size_mb'] = json_uuid['data'][i]['file_size'] / 1000000 + ' MB'
                // Duplicate or no
                json_uuid['data'][i]['file_duplicate'] = json_uuid['data'][i]['file_etag_duplicate'] == 1 ? 'Yes' : 'No'
            });

            // initialize table or update table
            if (!$.fn.dataTable.isDataTable($('#table-files'))) {
                // initialize table
                $('#table-files').DataTable({
                bAutoWidth : false,
                aaData : json_uuid['data'],
                aoColumns : [
                    {
                        "data": "file_date_true"
                    },
                    {
                        "data": "file_link"
                    },
                    {
                        "data": "file_size_mb"
                    },
                    {
                        "data": "file_duplicate"
                    }
                ],
                columnDefs: [
                    {
                        title: "Date",
                        width: "20%",
                        targets: 0
                    },
                    {
                        title: "File name",
                        targets: 1
                    },
                    {
                        title: "File size (MB)",
                        width: "20%",
                        className: "dt-center",
                        targets: 2
                    },
                    {
                        title: "Duplicate file?",
                        width: "20%",
                        className: "dt-center",
                        targets: 3
                    }
                ],
                order: [[0, "desc"]]
                });
                // enable table
                $('.half-right').css('display', 'inline-block')

            } else {
                // update table
                let datatable = $('#table-files').DataTable()
                datatable.clear().rows.add(json_uuid['data']).draw();
            }

            // update API URL
            let api_url = 'https://api.opencovid.ca/archive?uuid=' + uuid
            $('#api-url').html('<a href="' + api_url + '">' + api_url + '</a>')

            // jump to top of page
            $('#title-archive')[0].scrollIntoView();
        }

        // function: build datasets table
        async function buildTableDatasets(json_datasets) {

            // extract data from JSON
            const datasets = Object.keys(json_datasets).map(key => json_datasets[key]);

            // create single group variable from meta_group_1 and meta_group_2
            datasets.forEach(function(d) {
                if (typeof(d['metadata']['meta_group_2']) == "undefined") {
                    d['meta_group'] = d['metadata']['meta_group_1']
                } else {
                    d['meta_group'] = d['metadata']['meta_group_1'] + ' / ' + d['metadata']['meta_group_2']
                }
            });
            
            // create HTML link for URL
            datasets.forEach(function(d) {
                if (typeof(d['url']) == 'undefined') {
                    d['url'] = 'Dynamic URL retrieved from: <a href="' + d['metadata']['meta_url'] + '">' + d['metadata']['meta_url'] + '</a>'
                } else {
                    d['url'] = '<a href="' + d['url'] + '">' + d['url'] + '</a>'
                }
            });

            // initialize table
            let table = $('#table-datasets').DataTable({
                bAutoWidth : false,
                aaData : datasets,
                aoColumns : [
                    {
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: ''
                    },
                    {
                        "mData": "meta_group"
                    },
                    {
                        "mData": "metadata.meta_url_name"
                    },
                    {
                        "mData": "metadata.meta_name"
                    },
                    {
                        "mData": "active"
                    },
                    {
                        "mData": "url"
                    }
                ],
                columnDefs: [
                    {
                        title: "",
                        width: "5%",
                        targets: 0
                    },
                    {
                        title: "Group",
                        width: "10%",
                        targets: 1
                    },
                    {
                        title: "File group",
                        width: "25%",
                        targets: 2
                    },
                    {
                        title: "File name",
                        width: "25%",
                        targets: 3,
                    },
                    {
                        title: "Active?",
                        width: "10%",
                        targets: 4,
                        className: "dt-center",
                        searchable: false
                    },
                    {
                        title: "URL",
                        width: "25%",
                        targets: 5,
                    }
                ],
                order: [[1, "asc"], [2, "asc"], [3, "asc"]],
                pageLength: 25
            });

            // construct row details
            function row_details(d) {
                let html =
                '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                    '<tr>' +
                        '<td style="width:10%;">ID name:</td>' +
                        '<td style="width:90%;">' + d['id_name'] + '</td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>File group:</td>' +
                        '<td><a href="' + d['metadata']['meta_url'] + '">' + d['metadata']['meta_url_name'] + '</a></td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>File name:</td>' +
                        '<td>' + d['metadata']['meta_name'] + '</td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>Active:</td>' +
                        '<td>' + d['active'] + '</td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>URL:</td>' +
                        '<td>' + d['url'] + '</td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>UUID:</td>' +
                        '<td><a href="https://api.opencovid.ca/archive?uuid=' + d['uuid'] + '">' + d['uuid'] + '</a></td>' +
                    '</tr>' +
                    '<tr>' +
                        '<td>File path:</td>' +
                        '<td>' + d['dir_parent'] + '/' + d['dir_file'] + '/' + d['file_name'] + '.' + d['file_ext'] + '</td>' +
                    '</tr>' +
                    (typeof(d['notes']['notes_data']) == "undefined" ? '' :
                    '<tr>' +
                        '<td>Data notes:</td>' +
                        '<td>' + d['notes']['notes_data'] + '</td>' +
                    '</tr>') +
                    (typeof(d['notes']['notes_usage']) == "undefined" ? '' :
                    '<tr>' +
                        '<td>Usage notes:</td>' +
                        '<td>' + d['notes']['notes_usage'] + '</td>' +
                    '</tr>') +
                    (typeof(d['notes']['notes_misc']) == "undefined" ? '' :
                    '<tr>' +
                        '<td>Misc notes:</td>' +
                        '<td>' + d['notes']['notes_misc'] + '</td>' +
                    '</tr>') +
                '</table>'
                return html
            };

            // add on click event for opening/closing row details
            $('#table-datasets tbody').on('click', 'td.dt-control', function() {
                // select row
                let tr = $(this).closest('tr');
                let row = table.row(tr);
                // open or close row
                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(row_details(row.data())).show();
                    tr.addClass('shown');
                }
            });
        }

        // function: get value of parameter in query string
        function getParamFromQueryString(param) {
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
            // get value of chosen parameter
            let value = params[param]
            // return value
            return value
        }

        // function: build page
        async function buildPage() {
            // get JSON datasets
            const json_datasets = await getDatasets()

            // get directories
            let dirs = await getDirs(json_datasets['data'])

            // add files to directories
            dirs = await getFiles(json_datasets['data'], dirs)

            // build tree
            let root = await buildTree(dirs)
            
            // initialize tree
            let tree = new TreeView(root, '#tree')

            // build datasets table
            buildTableDatasets(json_datasets['data'])
        }

        // build page
        buildPage()

    </script>
</head>
<body>
    <h2 id="title-archive" class="leftpad">Canadian COVID-19 Data Archive: Data Explorer</h2>

    <p class="leftpad">Datasets are identified by name; see <a href="#table-datasets">Search list of datasets</a> for more details on each dataset.</p>

    <div id="container-files">
        <div id="tree" class="half"></div><div id="table-container" class="half half-right"><table id="table-files" class="display"></table><p class="leftpad">Data retrieved from: <span id="api-url"></span></p></div>
    </div>

    <h2 id="title-datasets" class="leftpad">Search list of datasets</h2>

    <p class="leftpad">Click the green button to see more details about each dataset.</p>

    <div id="container-datasets" class="fullpad">
        <table id="table-datasets" class="display"></table></div>
    </div>

</body>
</html>